{% extends 'base.html' %}

{% block content %}
    <h2>Capture ID Proof and User Details</h2>

    <!-- Camera Access for ID Proof -->
    <h3>Capture ID Proof</h3>
    <video id="camera-feed" autoplay playsinline width="340" height="180"></video>
    <button id="capture-id-proof" class="btn btn-primary mt-2">Capture ID Proof</button>
    <canvas id="id-proof-canvas" width="40" height="80" style="display: none;"></canvas>
    <img id="captured-id-proof" style="display: none; max-width: 140px; margin-top: 5px;" alt="Captured ID Proof" />

    <!-- User Details Form -->
    <h3>User Details</h3>
    <form method="POST" action="{% url 'visitor_form' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-group">
            <label for="name" class="form-label">Name</label>
            <input type="text" class="form-control" id="name" name="name" required>
        </div>
        <div class="form-group">
            <label for="phone" class="form-label">Phone</label>
            <input type="text" class="form-control" id="phone" name="phone" required>
        </div>
        <div class="form-group">
            <label for="address" class="form-label">Address</label>
            <input type="text" class="form-control" id="address" name="address" required>
        </div>
        <div class="form-group">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" name="email" required>
        </div>
        <div class="form-group">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" name="description" required></textarea>
        </div>

        <!-- Hidden input to store the captured ID proof image data -->
        <input type="hidden" id="id-proof-data" name="id_proof_data">

        <div class="my-3 d-flex justify-content-between">
            <button type="submit" class="btn btn-success">Submit</button>
            <a href="{% url 'visitor_list' %}" class="btn btn-info">Visitor List</a>
        </div>
    </form>

    <script>
        // JavaScript for handling camera access and capturing ID proof
        const videoElement = document.getElementById('camera-feed');
        const captureButton = document.getElementById('capture-id-proof');
        const idProofCanvas = document.getElementById('id-proof-canvas');
        const capturedIdProof = document.getElementById('captured-id-proof');
        const idProofDataInput = document.getElementById('id-proof-data');

        // Request camera access
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoElement.srcObject = stream;
            } catch (err) {
                console.error('Error accessing camera:', err);
                alert('Camera permission is required.');
            }
        }

        // Capture the current frame from the video feed
        captureButton.addEventListener('click', () => {
            const context = idProofCanvas.getContext('2d');
            idProofCanvas.width = videoElement.videoWidth;
            idProofCanvas.height = videoElement.videoHeight;
            context.drawImage(videoElement, 0, 0, idProofCanvas.width, idProofCanvas.height);

            const imageData = idProofCanvas.toDataURL('image/png');
            capturedIdProof.src = imageData;
            capturedIdProof.style.display = 'block'; // Show the captured image
            idProofDataInput.value = imageData; // Set the hidden input value
        });

        // Initialize the camera
        startCamera();
    </script>
{% endblock %}
